# KEEP THIS IN SYNC WITH https://github.com/coreos/fedora-coreos-config/blob/testing-devel/manifests/bootupd.yaml
# Integration with https://github.com/coreos/bootupd
# xref https://github.com/coreos/fedora-coreos-tracker/issues/510
packages:
  - bootupd

postprocess:
  - |
    #!/bin/bash
    set -xeuo pipefail

    # Transforms /usr/lib/ostree-boot into a bootupd-compatible update payload
    /usr/bin/bootupctl backend generate-update-metadata

    # Trigger a bootloader update on boot
    cat > /usr/lib/systemd/system/bootloader-update.service << 'EOF'
    [Unit]
    Description=Update bootloader on boot
    Documentation=https://github.com/coreos/bootupd

    [Service]
    Type=oneshot
    ExecStart=/usr/bin/bootupctl update
    RemainAfterExit=yes
    MountFlags=slave

    [Install]
    WantedBy=multi-user.target
    EOF
    chmod 644 /usr/lib/systemd/system/bootloader-update.service
    echo "enable bootloader-update.service" > /usr/lib/systemd/system-preset/81-atomic-desktop.preset

    # Turn permissive mode on for bootupd until all SELinux issues are fixed
    semanage permissive --noreload --add bootupd_t

    # Ensure that BLS support is enabled when regenerating GRUB configs
    cat > /usr/lib/systemd/system/atomic-enable-grub-bls-support.service << 'EOF'
    [Unit]
    Description=Force enable BLS support in GRUB config
    Documentation=https://fedoraproject.org/wiki/Changes/ComposefsAtomicDesktops

    [Service]
    Type=oneshot
    ExecStart=bash -c "if [[ -f '/etc/default/grub' ]] && [[ $(grep -c 'GRUB_ENABLE_BLSCFG=true' '/etc/default/grub') != 1 ]]; then sed -i '/GRUB_ENABLE_BLSCFG=/d' '/etc/default/grub'; echo 'GRUB_ENABLE_BLSCFG=true' >> '/etc/default/grub'; fi"
    RemainAfterExit=yes

    [Install]
    WantedBy=multi-user.target
    EOF

    echo "enable atomic-enable-grub-bls-support.service" > /usr/lib/systemd/system-preset/81-atomic-desktop.preset
